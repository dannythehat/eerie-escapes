name: Pull Request Checks

on:
  pull_request:
    branches: [main, develop]

jobs:
  pr-validation:
    name: PR Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check PR title format
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"
          if ! echo "$PR_TITLE" | grep -qE "^(feat|fix|docs|style|refactor|test|chore|ci|perf)(\(.+\))?: .+"; then
            echo "❌ PR title must follow conventional commits format"
            echo "Examples: feat: add new feature, fix(api): resolve bug"
            exit 1
          fi
          echo "✅ PR title format is valid"

      - name: Check for merge conflicts
        run: |
          git fetch origin ${{ github.base_ref }}
          if git merge-tree $(git merge-base HEAD origin/${{ github.base_ref }}) HEAD origin/${{ github.base_ref }} | grep -q "<<<<<"; then
            echo "❌ Merge conflicts detected"
            exit 1
          fi
          echo "✅ No merge conflicts"

      - name: Check file size limits
        run: |
          large_files=$(find . -type f -size +5M -not -path "./.git/*" -not -path "./node_modules/*")
          if [ -n "$large_files" ]; then
            echo "❌ Files larger than 5MB detected:"
            echo "$large_files"
            exit 1
          fi
          echo "✅ All files within size limits"

  label-pr:
    name: Auto Label PR
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Label based on changed files
        uses: actions/labeler@v5
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
